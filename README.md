# libavr

This is a firmware framework and utility library for AVR microcontrollers,
like the ATmega328 ones found in Arduino products. I wrote this code
for my own projects and my primary reason for publishing it is to provide
an example of my recent work to employers. If someone else has use for it
then that's great. It was designed to be used on a Linux (Debian) system
and I have not tried it on any other platform.

The library contains both general facilities and a couple of modules that handle
specific ICs that I happened to be working with. There is some example firmware
and a few Python scripts that facilitate communication between the AVR firmware
and other computing devices.

Please note that the code hasn't been systematically tested. Some of it hasn't
been tested at all. Exercise caution when using the library.


## Using the Library

The library depends on [AVR Libc](https://www.nongnu.org/avr-libc/). Personally,
I compile firmware with `avr-gcc`, convert it to an Intel hex file with `avr-objcopy`
and flash it to the MCU with `avrdude`. These are all available in Debian packages
(`avr-libc`, `gcc-avr`, `binutils-avr` and `avrdude`).

The library modules use the INM (Inter-Node Messaging) protocol to communicate
with other computing devices. This protocol is my own invention, basically
 [TLV](https://en.wikipedia.org/wiki/Type%E2%80%93length%E2%80%93value)
messages with simple datagram addressing and sequencing. The current implementation
only supports an USART data link.

Building the library on a Linux system should be a matter of installing the required
packages, cloning the repo and running `make` in the `avr/` subdirectory. You will
probably need at least AVR Libc, GCC and binutils with AVR support, GNU Make and some
tool that can flash built firmware to the MCU.

When you develop firmware that uses the library, I recommend that you think about the
functional requirements in terms of tasks running in the library's task scheduler.
Each task implements an activity that the firmware needs to perform, parallel to
and often independent of other tasks. Tasks may execute after a set delay (which might
be periodic) or be triggered by external or internal events. See the documentation in
`task_sched.h` for more information about how the scheduler works. Keep in mind that
some library modules need to be initialized via an appropriate function call before
use.

Building and flashing your firmware is not hard if you know how to do it. The makefile
for the example firmware should provide some useful hints. I'd recommend learning
enough to sort of know what you're doing before you try to flash anything, unless
you're running your development program hardware rich.

Once you have flashed your firmware, you can use the included Python modules to
communicate with it via INM. This aspect is not very well documented right now,
you'll probably have to look at the code in `inm_helper.py` and `inm.py` until you
get it. It's not hard, just somewhat complicated.


## Library Modules

All library header files have [naturaldocs](https://www.naturaldocs.org/) doc comments.
HTML documentation can be generated by running the command `make doc` in the library
source directory (i.e. `avr/`).

* `task_sched.h`: Task scheduler with runtime task management and delayed execution.
* `task_tlv.h`: Asynchronous TLV/INM communication module.
* `std_tlv.h`: Common message types for the TLV communication module.
* `memmon.h`: Memory monitoring via TLV messages.
* `tbouncer.h`: GPIO input debouncing with task notification.
* `i2chelper.h`: Asynchronous, interrupt-driven I2C (aka TWI) helper module.
* `spihelper.h`: Helper functions and macros for SPI communication.
* `mcp23018.h`: Helper module for controlling an MCP23018 I/O expander via I2C.
* `mcp4x.h`: Helper module for controlling an MCP4x potentiometer via SPI.


## Example Firmware

* `sched_blinker.c`: A simple LED blinker.
* `inm_node_demo.c`: Sensor sampling and notifications. WIP for a home security system.


## Python Modules and Scripts

These Python modules use [pySerial](https://pyserial.readthedocs.io/en/latest/pyserial.html)
for serial port communication.

* `inm.py`: INM communication API. Supports serial port and UDP/IP links.
* `inm_helper.py`: Convenience wrapper for an INM communication channel.
* `inm_router.py`: INM message router script. May be installed as a Linux service.
* `inm_memmon.py`: Text-based visualization script for libavr memory monitors.
